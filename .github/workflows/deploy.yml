name: Deploy to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 1. Start a fresh, empty MySQL database for testing
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: localTest
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install

      # 2. Load your schema into the empty Service Container
      - name: Initialize Database Schema
        run: |
          # Wait for MySQL to be ready (just in case)
          until mysqladmin ping -h 127.0.0.1 -P 3306 --user=root --password=root --silent; do
            echo "Waiting for MySQL..."
            sleep 1
          done

          # Run the schema file to create tables
          mysql -h 127.0.0.1 -P 3306 -u root -proot localTest < schema.sql
        env:
          # The mysql client is pre-installed on ubuntu-latest runners
          MYSQL_PWD: root 

      # 3. Run Tests against the Service Container
      - name: Run unit tests
        env:
          # Database Config (Points to Service Container)
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: root
          DB_NAME: localTest
          DB_PORT: 3306
          NODE_ENV: test
          TEST_VERBOSE: '1' # Show full logs if tests fail

          # Application Secrets from GitHub Actions
          APP_PORT: ${{ secrets.PORT }}
          UTC_DEBUG: ${{ secrets.UTC_DEBUG }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          BCRYPT_SALT: ${{ secrets.BCRYPT_SALT }}
          NOTIFICATION_ENCRYPTION_KEY: ${{ secrets.NOTIFICATION_ENCRYPTION_KEY }}
          PAYMENT_ENCRYPTION_KEY: ${{ secrets.PAYMENT_ENCRYPTION_KEY }}
          CVC_HMAC_SECRET: ${{ secrets.CVC_HMAC_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_S3_DEFAULT_PREFIX: ${{ secrets.AWS_S3_DEFAULT_PREFIX }}
          UPLOAD_MAX_BYTES: ${{ secrets.UPLOAD_MAX_BYTES }}
        
        run: npm test --coverage 

      - name: Build project
        run: npm run build --if-present

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "./"
          target: "/home/ubuntu/Strands-Backend"
          rm: true
          
      - name: Restart PM2 on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/Strands-Backend
            
            # 1. Install dependencies
            npm install --production
            
            # 2. Generate the Config File
            PM2_CONFIG=$(cat <<EOF
            {
              "apps": [
                {
                  "name": "strands-backend",
                  "script": "./src/server.js",
                  "env": {
                    "NODE_ENV": "production", 
                    "APP_PORT": "${{ secrets.PORT }}",
                    "UTC_DEBUG": "${{ secrets.UTC_DEBUG }}",
                    "DB_HOST": "${{ secrets.DB_HOST }}",
                    "DB_USER": "${{ secrets.DB_USER }}",
                    "DB_PASSWORD": "${{ secrets.DB_PASSWORD }}",
                    "DB_NAME": "${{ secrets.DB_NAME }}",
                    "DB_PORT": "${{ secrets.DB_PORT }}",
                    "JWT_SECRET": "${{ secrets.JWT_SECRET }}",
                    "BCRYPT_SALT": "${{ secrets.BCRYPT_SALT }}",
                    "NOTIFICATION_ENCRYPTION_KEY": "${{ secrets.NOTIFICATION_ENCRYPTION_KEY }}",
                    "PAYMENT_ENCRYPTION_KEY": "${{ secrets.PAYMENT_ENCRYPTION_KEY }}",
                    "CVC_HMAC_SECRET": "${{ secrets.CVC_HMAC_SECRET }}",
                    "AWS_ACCESS_KEY_ID": "${{ secrets.AWS_ACCESS_KEY_ID }}",
                    "AWS_SECRET_ACCESS_KEY": "${{ secrets.AWS_SECRET_ACCESS_KEY }}",
                    "AWS_REGION": "${{ secrets.AWS_REGION }}",
                    "AWS_S3_BUCKET": "${{ secrets.AWS_S3_BUCKET }}",
                    "AWS_S3_DEFAULT_PREFIX": "${{ secrets.AWS_S3_DEFAULT_PREFIX }}",
                    "UPLOAD_MAX_BYTES": "${{ secrets.UPLOAD_MAX_BYTES }}"
                  }
                }
              ]
            }
            EOF
            )

            echo "$PM2_CONFIG" > pm2_temp_config.json
            
            # 3. CRITICAL FIX: Kill the old process first to free up RAM/DB Connections
            pm2 delete strands-backend || true
            
            # 4. Start fresh
            pm2 start pm2_temp_config.json
            pm2 save
            
            rm pm2_temp_config.json
